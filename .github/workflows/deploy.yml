name: Deploy to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "${{ secrets.GCP_HOST }}" >> ~/.ssh/known_hosts
      
    - name: Deploy to GCP
      env:
        GCP_USERNAME: ${{ secrets.GCP_USERNAME }}
        GCP_HOST: ${{ secrets.GCP_HOST }}
        APP_KEY: ${{ secrets.APP_KEY }}
        DB_DATABASE: ${{ secrets.DB_DATABASE }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        ssh "${GCP_USERNAME}@${GCP_HOST}" << 'ENDSSH'
          set -e
          
          cd ~/laravel-app || exit
          
          git pull origin main
          
          cat > .env << 'ENDENV'
        APP_NAME=LearnGrowDigital
        APP_ENV=production
        APP_DEBUG=false
        APP_KEY=${APP_KEY}
        APP_URL=https://learngrowdigital.co.uk
        
        LOG_CHANNEL=stack
        LOG_LEVEL=error
        
        DB_CONNECTION=mysql
        DB_HOST=db
        DB_PORT=3306
        DB_DATABASE=${DB_DATABASE}
        DB_USERNAME=${DB_USERNAME}
        DB_PASSWORD=${DB_PASSWORD}
        
        BROADCAST_DRIVER=log
        CACHE_DRIVER=file
        FILESYSTEM_DISK=local
        QUEUE_CONNECTION=sync
        SESSION_DRIVER=file
        SESSION_LIFETIME=120
        ENDENV
          
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          sleep 10
          
          docker compose exec -T app php artisan migrate --force
          docker compose exec -T app php artisan config:cache
          docker compose exec -T app php artisan route:cache
          docker compose exec -T app php artisan view:cache
          docker compose exec -T app chown -R www-data:www-data /var/www/html/storage
          docker compose exec -T app chmod -R 775 /var/www/html/storage
          
          echo "✅ Deployment completed successfully!"
        ENDSSH
      
    - name: Verify deployment
      run: |
        set -e
        echo "Waiting 15 seconds for application to start..."
        sleep 15
        
        response=$(curl -s -o /dev/null -w "%{http_code}" https://learngrowdigital.co.uk)
        
        if [ "${response}" = "200" ] || [ "${response}" = "302" ]; then
          echo "✅ Deployment verified! Site returned status code: ${response}"
        else
          echo "❌ Deployment verification failed! Status code: ${response}"
          exit 1
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed! Check the logs above for details."